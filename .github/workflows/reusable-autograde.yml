name: Reusable Autograde

on:
  workflow_call:
    inputs:
      milestone:
        description: 'Milestone to grade (e.g. M0, M1, M2, M3)'
        required: true
        type: string
      tag:
        description: 'Git tag to checkout (optional, defaults to milestone)'
        required: false
        type: string

jobs:
  autograde:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout student repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine tag
        id: vars
        run: |
          if [ -z "${{ inputs.tag }}" ]; then
            echo "TAG=${{ inputs.milestone }}" >> $GITHUB_OUTPUT
          else
            echo "TAG=${{ inputs.tag }}" >> $GITHUB_OUTPUT
          fi

      - name: Checkout grading logic
        uses: actions/checkout@v4
        with:
          repository: 2110634-SDD/sdd-autograding
          path: sdd-autograding
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run autograder
        env:
          MILESTONE: ${{ inputs.milestone }}
          TAG: ${{ steps.vars.outputs.TAG }}
        run: |
          set -euxo pipefail

          echo "▶ Grading milestone: $MILESTONE"
          echo "▶ Using tag: $TAG"

          git checkout "tags/$TAG"

          cd sdd-autograding
          
          python -m grader.main \
            --milestone "$MILESTONE" \
            --repo-path "$GITHUB_WORKSPACE" \
            --output "$GITHUB_WORKSPACE/grading/grading_result_${MILESTONE}.json" || true

          mkdir -p "$GITHUB_WORKSPACE/grading"
          SRC="$GITHUB_WORKSPACE/sdd-autograding/grading_result.json"
          DST="$GITHUB_WORKSPACE/grading/grading_result_${MILESTONE}.json"

          test -f "$SRC"
          cp -f "$SRC" "$DST"
          ls -la "$DST"

      - name: Debug  locate grading_result.json
        if: always()
        run: |
          echo "PWD=$(pwd)"
          echo "GITHUB_WORKSPACE=$GITHUB_WORKSPACE"
          echo "---- find grading_result.json ----"
          find "$GITHUB_WORKSPACE" -maxdepth 5 -name "grading_result.json" -print -ls || true
          echo "---- list workspace root ----"
          ls -la "$GITHUB_WORKSPACE" || true
          echo "---- list sdd-autograding ----"
          ls -la "$GITHUB_WORKSPACE/sdd-autograding" || true

      - name: Upload grading result
        uses: actions/upload-artifact@v4
        with:
          name: grading-result-${{ inputs.milestone }}
          path: grading/grading_result_${{ inputs.milestone }}.json
          if-no-files-found: error